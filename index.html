<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Nutritionist & Health Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 20px auto; padding: 0 20px; background-color: #f9f9f9; color: #333; }
        h1, h2 { color: #0056b3; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .container { background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 25px; }
        form div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, button { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        .results-box { margin-top: 20px; padding: 15px; background-color: #e9f5ff; border-left: 5px solid #007bff; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <h1>AI Nutritionist & Health Tracker</h1>

    <div class="container">
        <h2>คำนวณค่าสุขภาพของคุณ</h2>
        <form id="health-form">
             <div>
                <label for="gender">เพศ:</label>
                <select id="gender" name="gender" required><option value="male">ชาย</option><option value="female">หญิง</option></select>
            </div>
            <div><label for="age">อายุ (ปี):</label><input type="number" id="age" name="age" required></div>
            <div><label for="weight">น้ำหนัก (กก.):</label><input type="number" id="weight" name="weight" step="0.1" required></div>
            <div><label for="height">ส่วนสูง (ซม.):</label><input type="number" id="height" name="height" required></div>
            <div>
                <label for="activity">ระดับกิจกรรม:</label>
                <select id="activity" name="activity" required>
                    <option value="1.2">นั่งทำงาน, ไม่ค่อยออกกำลังกาย</option><option value="1.375">ออกกำลังกายเบาๆ (1-3 วัน/สัปดาห์)</option><option value="1.55">ออกกำลังกายปานกลาง (3-5 วัน/สัปดาห์)</option><option value="1.725">ออกกำลังกายหนัก (6-7 วัน/สัปดาห์)</option><option value="1.9">ออกกำลังกายหนักมาก (วันละ 2 ครั้ง)</option>
                </select>
            </div>
            <button type="submit">คำนวณ</button>
        </form>
        <div id="results"><p>ผลลัพธ์การคำนวณจะแสดงที่นี่...</p></div>
    </div>

    <div class="container">
        <h2>แนะนำเมนูอาหาร</h2>
        <p>ใส่เป้าหมายแคลอรี่ต่อวันของคุณ เพื่อรับการแนะนำชุดเมนูอาหาร</p>
        <form id="recommend-form">
            <div>
                <label for="target-calories">เป้าหมายแคลอรี่ (kcal):</label>
                <input type="number" id="target-calories" value="2000" required>
            </div>
            <button type="submit">แนะนำเมนู</button>
        </form>
        <div id="recommendation-results" class="results-box" style="margin-top: 20px;">
            <p>เมนูที่แนะนำจะแสดงที่นี่...</p>
        </div>
    </div>

    <div class="container">
        <h2>บันทึกมื้ออาหาร</h2>
        <form id="log-form">
            <div><label for="meal-name">ชื่ออาหาร:</label><input type="text" id="meal-name" required></div>
            <div><label for="calories">แคลอรี่ (kcal):</label><input type="number" id="calories" required></div>
            <div><label for="sodium">โซเดียม (mg):</label><input type="number" id="sodium" required></div>
            <button type="submit">บันทึกมื้ออาหาร</button>
        </form>
    </div>

    <div class="container">
        <h2>รายการอาหารที่บันทึกไว้</h2>
        <table id="log-table">
            <thead>
                <tr><th>วันที่</th><th>รายการ</th><th>แคลอรี่ (kcal)</th><th>โซเดียม (mg)</th></tr>
            </thead>
            <tbody id="log-table-body">
                </tbody>
        </table>
    </div>
    
    <div class="container">
        <h2>กราฟสรุปแคลอรี่รายวัน</h2>
        <canvas id="calorie-chart"></canvas>
    </div>

    <div class="container">
        <h2>กราฟสรุปแคลอรี่รายสัปดาห์ (เฉลี่ยต่อวัน)</h2>
        <canvas id="weekly-calorie-chart"></canvas>
    </div>


    <script>
        // URL ของ Backend API
        const API_URL = 'http://127.0.0.1:5000';

        // --- อ้างอิงถึง Elements ---
        const healthForm = document.getElementById('health-form');
        const resultsDiv = document.getElementById('results');
        const logForm = document.getElementById('log-form');
        const logTableBody = document.getElementById('log-table-body');
        const chartCanvas = document.getElementById('calorie-chart');
        let calorieChart; // ตัวแปรสำหรับเก็บ instance ของกราฟ

        // <<< ใหม่: อ้างอิงถึง Elements ของระบบแนะนำอาหาร >>>
        const recommendForm = document.getElementById('recommend-form');
        const recommendationResultsDiv = document.getElementById('recommendation-results');

        const weeklyChartCanvas = document.getElementById('weekly-calorie-chart');
        let weeklyCalorieChart;

        // --- Event Listeners ---
        // ... (โค้ดของ healthForm และ logForm เหมือนเดิม) ...

        // <<< ใหม่: Event Listener สำหรับฟอร์มแนะนำอาหาร >>>
        recommendForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const targetCalories = document.getElementById('target-calories').value;

            if (!targetCalories || targetCalories <= 0) {
                alert('กรุณาใส่เป้าหมายแคลอรี่ที่ถูกต้อง');
                return;
            }

            recommendationResultsDiv.innerHTML = '<p>กำลังค้นหาเมนูที่เหมาะสม...</p>';

            fetch(`${API_URL}/recommend_meals?target=${targetCalories}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) { throw new Error(data.error); }
                    
                    let totalCalories = 0;
                    let html = '<h4>แผนการกินที่แนะนำ:</h4><ul>';
                    data.forEach(meal => {
                        html += `<li><strong>${meal.type}:</strong> ${meal.name} (${meal.calories} kcal)</li>`;
                        totalCalories += meal.calories;
                    });
                    html += '</ul>';
                    html += `<p><strong>แคลอรี่รวมโดยประมาณ:</strong> ${totalCalories} kcal</p>`;

                    recommendationResultsDiv.innerHTML = html;
                })
                .catch(error => {
                    recommendationResultsDiv.innerHTML = `<p>เกิดข้อผิดพลาด: ${error.message}</p>`;
                });
        });

        // --- Event Listeners ---

        // 1. จัดการการคำนวณค่าสุขภาพ
        healthForm.addEventListener('submit', function(event) {
            event.preventDefault();
            // ... (โค้ดส่วนนี้เหมือนเดิม)
            const formData = new FormData(healthForm);
            const requestData = {
                "gender": formData.get('gender'),
                "age": parseInt(formData.get('age')),
                "weight_kg": parseFloat(formData.get('weight')),
                "height_cm": parseFloat(formData.get('height')),
                "activity_factor": parseFloat(formData.get('activity'))
            };
            resultsDiv.innerHTML = '<p>กำลังคำนวณ...</p>';
            fetch(`${API_URL}/calculate`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) { throw new Error(data.error); }
                resultsDiv.innerHTML = `
                    <p><strong>BMI (ดัชนีมวลกาย):</strong> ${data.bmi}</p>
                    <p><strong>BMR (อัตราการเผาผลาญพื้นฐาน):</strong> ${data.bmr} แคลอรี่/วัน</p>
                    <p><strong>TDEE (พลังงานที่ต้องการต่อวัน):</strong> ${data.tdee} แคลอรี่/วัน</p>
                `;
            })
            .catch(error => {
                resultsDiv.innerHTML = `<p>เกิดข้อผิดพลาด: ${error.message}</p>`;
            });
        });

        // 2. จัดการการบันทึกมื้ออาหาร
        logForm.addEventListener('submit', function(event) {
            event.preventDefault();

            // ดึงข้อมูลจากฟอร์ม และใช้ .trim() เพื่อตัดช่องว่างหน้า-หลัง
            const mealName = document.getElementById('meal-name').value.trim();
            const caloriesValue = document.getElementById('calories').value;
            const sodiumValue = document.getElementById('sodium').value;

            // <<< ส่วนที่เพิ่มเข้ามา: การตรวจสอบข้อมูล >>>
            // ตรวจสอบว่าข้อมูลไม่ได้เป็นค่าว่าง หรือไม่ใช่ตัวเลข
            if (!mealName || caloriesValue === '' || sodiumValue === '') {
                alert('กรุณากรอกข้อมูลมื้ออาหารให้ครบทุกช่องครับ');
                return; // หยุดการทำงานของฟังก์ชันทันที
            }
            
            const calories = parseInt(caloriesValue);
            const sodium = parseInt(sodiumValue);

            if (isNaN(calories) || isNaN(sodium) || calories < 0 || sodium < 0) {
                alert('กรุณาป้อนค่าแคลอรี่และโซเดียมเป็นตัวเลขที่ไม่ติดลบครับ');
                return; // หยุดการทำงาน
            }
            // <<< สิ้นสุดส่วนที่เพิ่มเข้ามา >>>

            const mealData = {
                meal_name: mealName,
                calories: calories,
                sodium: sodium
            };

            fetch(`${API_URL}/log_meal`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(mealData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    logForm.reset();
                    fetchAndDisplayLogs();
                } else {
                    alert('ไม่สามารถบันทึกข้อมูลได้');
                }
            })
            .catch(error => console.error('Error logging meal:', error));
        });

        // --- Functions ---

        // 3. ฟังก์ชันสำหรับดึงและแสดงผลข้อมูลที่บันทึกไว้
        async function fetchAndDisplayLogs() {
            try {
                const response = await fetch(`${API_URL}/get_logs`);
                const logs = await response.json();
                
                // เติมข้อมูลลงในตาราง
                logTableBody.innerHTML = ''; // ล้างข้อมูลเก่า
                logs.forEach(log => {
                    const date = new Date(log.timestamp).toLocaleDateString('th-TH');
                    const row = `<tr>
                                    <td>${date}</td>
                                    <td>${log.meal_name}</td>
                                    <td>${log.calories}</td>
                                    <td>${log.sodium}</td>
                                 </tr>`;
                    logTableBody.innerHTML += row;
                });
                
                // สร้าง/อัปเดตกราฟ
                renderChart(logs);

            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }
        
        // 4. ฟังก์ชันสำหรับวาดกราฟ
        function renderChart(logs) {
            // ประมวลผลข้อมูลเพื่อสรุปแคลอรี่รายวัน
            const dailyData = logs.reduce((acc, log) => {
                const date = new Date(log.timestamp).toLocaleDateString('th-TH');
                if (!acc[date]) {
                    acc[date] = 0;
                }
                acc[date] += log.calories;
                return acc;
            }, {});

            const chartLabels = Object.keys(dailyData).reverse();
            const chartDataPoints = Object.values(dailyData).reverse();
            
            // ถ้ามีกราฟเก่าอยู่ ให้ทำลายทิ้งก่อน
            if (calorieChart) {
                calorieChart.destroy();
            }

            // สร้างกราฟใหม่
            calorieChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'แคลอรี่ที่บริโภค',
                        data: chartDataPoints,
                        borderColor: 'rgba(0, 123, 255, 1)',
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    },
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'สรุปแคลอรี่รายวัน' }
                    }
                }
            });
        }

        async function fetchAndDisplayWeeklySummary() {
            try {
                const response = await fetch(`${API_URL}/get_weekly_summary`);
                const summaryData = await response.json();

                if (summaryData.error) {
                    throw new Error(summaryData.details);
                }
                
                renderWeeklyChart(summaryData);

            } catch (error) {
                console.error('Error fetching weekly summary:', error);
                weeklyChartCanvas.getContext('2d').fillText('ไม่สามารถโหลดข้อมูลรายสัปดาห์ได้', 10, 50);
            }
        }

        // <<< ใหม่: ฟังก์ชันสำหรับวาดกราฟแท่งรายสัปดาห์ >>>
        function renderWeeklyChart(summaryData) {
            if (weeklyCalorieChart) {
                weeklyCalorieChart.destroy(); // ทำลายกราฟเก่าทิ้งก่อน
            }

            const labels = summaryData.map(item => item.week_label);
            const dataPoints = summaryData.map(item => item.avg_calories_per_day);

            weeklyCalorieChart = new Chart(weeklyChartCanvas, {
                type: 'bar', // <<< เปลี่ยนชนิดกราฟเป็น 'bar'
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ค่าเฉลี่ยแคลอรี่ต่อวัน',
                        data: dataPoints,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'แคลอรี่ (kcal)' }
                        }
                    },
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'เปรียบเทียบค่าเฉลี่ยแคลอรี่ในแต่ละสัปดาห์' }
                    }
                }
            });
        }

        // <<< อัปเกรด: สั่งให้ดึงข้อมูลทั้งรายวันและรายสัปดาห์เมื่อหน้าเว็บโหลดเสร็จ >>>
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplayLogs(); // ดึงข้อมูลรายวัน (เหมือนเดิม)
            fetchAndDisplayWeeklySummary(); // ดึงข้อมูลรายสัปดาห์ (เพิ่มเข้ามาใหม่)
        });

    </script>
</body>
</html>